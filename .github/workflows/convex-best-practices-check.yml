name: Convex Best Practices Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'packages/backend/convex/**'
      - '**/convex/**'

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  convex-best-practices:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Configure git identity
        run: |
          git config user.name "Convex Best Practices Bot"
          git config user.email "convex-bot@syntaxia.com"

      - name: Convex Best Practices Review
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          MODEL: grok-code-fast-1
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BLOCKING_REVIEW: ${{ vars.CONVEX_BLOCKING_REVIEW || 'true' }}
        run: |
          cursor-agent --force --model "$MODEL" --output-format=text --print 'You are a specialized Convex code reviewer operating in GitHub Actions. Focus ONLY on Convex best practices violations.

          Context:
          - Repo: ${{ github.repository }}
          - PR Number: ${{ github.event.pull_request.number }}
          - PR Head SHA: ${{ github.event.pull_request.head.sha }}
          - PR Base SHA: ${{ github.event.pull_request.base.sha }}
          - Blocking Review: ${{ env.BLOCKING_REVIEW }}

          Convex Best Practices to Check:

          üö® CRITICAL VIOLATIONS (Blocking):
          1. Missing await on promises (ctx.db.*, ctx.runQuery, ctx.runMutation, ctx.scheduler.*)
          2. Using .filter() on database queries instead of .withIndex()
          3. Using .collect() on potentially large result sets without pagination
          4. Missing argument validators on public functions
          5. Missing access control on public functions
          6. Scheduling public functions instead of internal functions
          7. Direct database access (ctx.db) in actions

          ‚ö° PERFORMANCE ISSUES (High Priority):
          8. Redundant indexes in schema.ts
          9. Unnecessary ctx.runAction() calls (use helper functions instead)
          10. Sequential ctx.runQuery/ctx.runMutation calls in actions
          11. Overuse of ctx.runQuery/ctx.runMutation in queries/mutations

          ‚ö†Ô∏è CODE QUALITY ISSUES (Medium Priority):
          12. Missing returns validator (should use v.null() if no return)
          13. Using deprecated v.bigint() instead of v.int64()
          14. Missing "use node"; directive in actions using Node.js
          15. Incorrect TypeScript types for Convex IDs (use Id<"table"> not string)

          Procedure:
          - Get existing comments: gh pr view --json comments
          - Get diff of only Convex files: gh pr diff -- "**/convex/**"
          - Analyze ONLY changed lines in Convex files
          - Focus on the 15 specific violations listed above
          - Check existing .cursor/rules/convex_best_practices.mdc for reference patterns

          Analysis Rules:
          - ONLY flag clear violations of the 15 specific practices above
          - Provide specific line references and suggest fixes
          - Include code examples in comments when helpful
          - Reference the official Convex best practices documentation
          - Mark resolved issues with ‚úÖ when fixed

          Commenting Format:
          - üö® Critical: [Brief description] - [Specific fix]
          - ‚ö° Performance: [Brief description] - [Optimization suggestion]  
          - ‚ö†Ô∏è Quality: [Brief description] - [Improvement suggestion]
          - ‚úÖ Resolved: [Brief acknowledgment of fix]

          Example Comments:
          - "üö® Critical: Missing await on ctx.db.insert() - Add await to prevent silent failures"
          - "‚ö° Performance: Using .filter() on messages query - Replace with .withIndex(\"by_author\") for better performance"
          - "‚ö†Ô∏è Quality: Missing returns validator - Add returns: v.null() to function definition"

          Submission Rules:
          - Max 15 inline comments total
          - Place comments on exact changed lines only
          - If critical violations found: echo "CONVEX_CRITICAL_ISSUES=true" >> $GITHUB_ENV
          - If no issues found: echo "CONVEX_CRITICAL_ISSUES=false" >> $GITHUB_ENV
          - Submit via GitHub Reviews API with inline comments
          - Include summary of total violations by category
          '

      - name: Check for critical Convex violations
        if: env.BLOCKING_REVIEW == 'true'
        run: |
          echo "Checking for critical Convex best practices violations..."
          echo "CONVEX_CRITICAL_ISSUES: ${CONVEX_CRITICAL_ISSUES:-unset}"

          if [ "${CONVEX_CRITICAL_ISSUES:-false}" = "true" ]; then
            echo "‚ùå Critical Convex best practices violations found. PR blocked until resolved."
            echo "Please review the inline comments and fix the issues before merging."
            echo "See .cursor/rules/convex_best_practices.mdc for reference."
            exit 1
          else
            echo "‚úÖ No blocking Convex issues found."
          fi

      - name: Post summary comment
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## üö® Convex Best Practices Violations Found

          This PR has been blocked due to critical Convex best practices violations.

          **Common fixes:**
          - Add \`await\` to all database operations and function calls
          - Replace \`.filter()\` with \`.withIndex()\` for database queries  
          - Add argument validators to all public functions
          - Implement access control for public functions
          - Use internal functions for scheduling

          **Reference:** See [\`.cursor/rules/convex_best_practices.mdc\`](.cursor/rules/convex_best_practices.mdc) for detailed examples and fixes.

          **Documentation:** [Convex Best Practices](https://docs.convex.dev/understanding/best-practices/)
          "
