name: Convex Best Practices Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'packages/backend/convex/**'
      - '**/convex/**'

concurrency:
  group: convex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  convex-best-practices:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Configure git identity
        run: |
          git config user.name "Convex Best Practices Bot"
          git config user.email "convex-bot@syntaxia.com"

      - name: Convex Best Practices Review
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          MODEL: auto
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cursor-agent --force --model "$MODEL" --output-format=text --print 'You are a specialized Convex code reviewer operating in GitHub Actions. Focus ONLY on Convex best practices violations.

          Context:
          - Repo: ${{ github.repository }}
          - PR Number: ${{ github.event.pull_request.number }}
          - PR Head SHA: ${{ github.event.pull_request.head.sha }}
          - PR Base SHA: ${{ github.event.pull_request.base.sha }}

          Convex Best Practices to Check:

          üö® CRITICAL ISSUES (Informational):
          1. Missing await on promises (ctx.db.*, ctx.runQuery, ctx.runMutation, ctx.scheduler.*)
          2. Using .filter() on database queries instead of .withIndex()
          3. Using .collect() on potentially large result sets without pagination
          4. Missing argument validators on public functions
          5. Missing access control on public functions
          6. Scheduling public functions instead of internal functions
          7. Direct database access (ctx.db) in actions

          ‚ö° PERFORMANCE ISSUES (Informational):
          8. Redundant indexes in schema.ts
          9. Unnecessary ctx.runAction() calls (use helper functions instead)
          10. Sequential ctx.runQuery/ctx.runMutation calls in actions
          11. Overuse of ctx.runQuery/ctx.runMutation in queries/mutations

          ‚ö†Ô∏è CODE QUALITY ISSUES (Informational):
          12. Missing returns validator (should use v.null() if no return)
          13. Using deprecated v.bigint() instead of v.int64()
          14. Missing "use node"; directive in actions using Node.js
          15. Incorrect TypeScript types for Convex IDs (use Id<"table"> not string)

          Procedure:
          - Get existing comments: gh pr view --json comments
          - Get diff of only Convex files: gh pr diff -- "**/convex/**"
          - Analyze ONLY changed lines in Convex files
          - Focus on the 15 specific violations listed above
          - Check for existing comment IDs to avoid duplicates

          Comment ID Tracking:
          - Each comment must include hidden ID: <!-- convex-rule-[number]-[file]-[line] -->
          - Examples: <!-- convex-rule-1-sessions.ts-45 --> for missing await on line 45
          - Examples: <!-- convex-rule-8-schema.ts-23 --> for redundant index on line 23
          - Rule numbers: 1-7 (Critical), 8-11 (Performance), 12-15 (Quality)
          - Before posting new comment, check if ID already exists in PR comments
          - If existing comment found: UPDATE it instead of creating duplicate
          - If violation is fixed: UPDATE existing comment to mark as resolved

          Analysis Rules:
          - ONLY flag clear violations of the 15 specific practices above
          - Provide specific line references and suggest fixes
          - Include code examples in comments when helpful
          - Track each violation with unique ID to prevent duplicates

          Commenting Format:
          - üö® Critical: [Brief description] - [Specific fix]
          - ‚ö° Performance: [Brief description] - [Optimization suggestion]  
          - ‚ö†Ô∏è Quality: [Brief description] - [Improvement suggestion]
          - ‚úÖ Resolved: [Brief acknowledgment] (for updating fixed issues)

          Submission Rules:
          - Max 15 inline comments total
          - Place comments on exact changed lines only
          - Submit ONLY ONE review via GitHub Reviews API with inline comments + summary
          - DO NOT post separate summary comments - include summary in the review body
          - Provide informational feedback only - DO NOT block PRs
          - All comments are suggestions for improvement
          - ALWAYS include hidden comment ID for tracking
          - Check existing comments before posting to avoid duplicates
          - Update existing comments when violations are fixed or changed
          
          Summary Format (for review body only):
          - Keep it under 3 sentences
          - Use natural language, not AI-speak
          - Put summary in the main review body, NOT as separate comment
          - Examples:
            * "Found 2 performance improvements in schema indexes and 1 missing await."
            * "Code looks good - just a couple minor optimizations possible."
            * "Spotted 3 small issues: redundant index, sequential queries, missing validator."
          - Avoid phrases like "I have analyzed" or "In conclusion"
          
          Important: Use GitHub Reviews API format:
          - ONE review submission with body + inline comments
          - Do NOT use gh pr comment for summary
          - Do NOT post multiple separate comments
          '