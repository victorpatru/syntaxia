name: Convex Best Practices Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'packages/backend/convex/**'
      - '**/convex/**'

concurrency:
  group: convex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  convex-best-practices:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Configure git identity
        run: |
          git config user.name "Convex Best Practices Bot"
          git config user.email "convex-bot@syntaxia.com"

      - name: Check for existing Convex comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing Convex rule comments..."
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
            --jq '.[] | select(.body | contains("convex-rule")) | .body' > existing_comments.txt
          
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            --jq '.[] | select(.body | contains("convex-rule")) | .body' >> existing_comments.txt
          
          echo "Found $(wc -l < existing_comments.txt) existing Convex comments"

      - name: Analyze Convex code for violations
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          MODEL: auto
        run: |
          cursor-agent --force --model "$MODEL" --output-format=text --print "You are a Convex code analyzer. Analyze ONLY the changed Convex files for best practices violations.

          Context:
          - PR: ${{ github.event.pull_request.number }}
          - Repository: ${{ github.repository }}

          Your task:
          1. Get the PR diff: gh pr diff ${{ github.event.pull_request.number }}
          2. Focus ONLY on files in packages/backend/convex/ or any path containing 'convex/'
          3. Analyze changed lines for these 15 violations:

          ðŸš¨ CRITICAL (1-7):
          1. Missing await on ctx.db.*, ctx.runQuery, ctx.runMutation, ctx.scheduler.*
          2. Using .filter() instead of .withIndex() on database queries
          3. Using .collect() without pagination on large result sets
          4. Missing argument validators on public functions
          5. Missing access control on public functions  
          6. Scheduling public functions instead of internal functions
          7. Direct ctx.db access in actions

          âš¡ PERFORMANCE (8-11):
          8. Redundant indexes in schema.ts
          9. Unnecessary ctx.runAction() calls
          10. Sequential ctx.runQuery/ctx.runMutation in actions
          11. Overuse of ctx.runQuery/ctx.runMutation

          âš ï¸ QUALITY (12-15):
          12. Missing returns validator
          13. Using deprecated v.bigint() instead of v.int64()
          14. Missing 'use node' directive in Node.js actions
          15. Wrong TypeScript types for Convex IDs

          Output format - for each violation found, output EXACTLY this format:
          VIOLATION|[rule_number]|[file_path]|[line_number]|[category]|[description]|[fix_suggestion]

          Example:
          VIOLATION|8|packages/backend/convex/schema.ts|115|Performance|Redundant index - by_user covered by by_user_status|Remove the by_user index

          If no violations found, output: NO_VIOLATIONS_FOUND

          IMPORTANT: Only analyze changed lines, provide specific line numbers, be concise." > analysis_output.txt

      - name: Create GitHub review from analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if grep -q "NO_VIOLATIONS_FOUND" analysis_output.txt; then
            echo "No violations found, skipping review creation"
            exit 0
          fi

          # Count violations and create summary
          violation_count=$(grep -c "VIOLATION|" analysis_output.txt || echo "0")
          
          if [ "$violation_count" -eq 0 ]; then
            echo "No violations found, skipping review creation"
            exit 0
          fi

          # Create summary based on violation count
          if [ "$violation_count" -eq 1 ]; then
            summary="Found 1 Convex best practice improvement."
          else
            summary="Found $violation_count Convex best practice improvements."
          fi

          # Start building the review JSON
          cat > review.json << EOF
          {
            "event": "COMMENT",
            "body": "$summary",
            "comments": [
          EOF

          # Process each violation and add to comments array
          first=true
          while IFS='|' read -r prefix rule_num file_path line_num category description fix; do
            if [ "$prefix" = "VIOLATION" ]; then
              # Check if this violation already exists
              comment_id="convex-rule-${rule_num}-$(basename "$file_path")-${line_num}"
              if grep -q "$comment_id" existing_comments.txt; then
                echo "Skipping duplicate comment: $comment_id"
                continue
              fi

              # Determine emoji based on category
              case "$category" in
                "Critical") emoji="ðŸš¨" ;;
                "Performance") emoji="âš¡" ;;
                "Quality") emoji="âš ï¸" ;;
                *) emoji="â„¹ï¸" ;;
              esac

              # Add comma if not first comment
              if [ "$first" = false ]; then
                echo "," >> review.json
              fi
              first=false

              # Add the comment to JSON
              cat >> review.json << EOF
              {
                "path": "$file_path",
                "line": $line_num,
                "side": "RIGHT",
                "body": "$emoji $category: $description\n\n<!-- $comment_id -->\n\n**Fix:** $fix"
              }
          EOF
            fi
          done < analysis_output.txt

          # Close the JSON
          cat >> review.json << EOF
            ]
          }
          EOF

          # Only submit if we have comments
          if [ "$first" = true ]; then
            echo "No new violations to report (all already exist)"
            exit 0
          fi

          # Submit the review
          echo "Submitting review with $(jq '.comments | length' review.json) comments"
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            -X POST --input review.json