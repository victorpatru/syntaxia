name: Convex Best Practices Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'packages/backend/convex/**'
      - '**/convex/**'

concurrency:
  group: convex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  convex-best-practices:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Configure git identity
        run: |
          git config user.name "Convex Best Practices Bot"
          git config user.email "convex-bot@syntaxia.com"

      - name: Check for existing Convex comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing Convex rule comments..."
          
          # The key fix: Check review comments (inline comments) - this is where our tracking IDs are!
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
            --jq '.[] | select(.body | contains("convex-rule")) | .body' > existing_comments.txt
          
          # Also check review bodies for any that might contain tracking IDs
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            --jq '.[] | select(.body | contains("convex-rule")) | .body' >> existing_comments.txt
          
          # Check for github-actions bot reviews (broader detection)
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            --jq '.[] | select(.user.login == "github-actions[bot]") | .body' >> existing_comments.txt
          
          comment_count=$(wc -l < existing_comments.txt | tr -d ' ')
          echo "Found $comment_count existing Convex comments"
          
          # Debug: show what we found
          if [ "$comment_count" -gt 0 ]; then
            echo "Sample of existing comments:"
            head -3 existing_comments.txt || true
          else
            echo "DEBUG: No convex-rule comments found. Checking for any github-actions comments..."
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
              --jq '.[] | select(.user.login == "github-actions[bot]") | .body' | head -2 || true
          fi

      - name: Load Convex best practices
        run: |
          echo "Loading Convex best practices reference..."
          cat .github/convex-best-practices.md > convex_practices.md

      - name: Analyze Convex code for violations
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          MODEL: auto
        run: |
          cursor-agent --force --model "$MODEL" --output-format=text --print "You are a Convex code analyzer. Analyze ONLY the changed Convex files for best practices violations.

          Context:
          - PR: ${{ github.event.pull_request.number }}
          - Repository: ${{ github.repository }}

          Reference the Convex best practices document in convex_practices.md for detailed examples and explanations.

          Your task:
          1. Read convex_practices.md to understand all 15 violation types
          2. Get the PR diff: gh pr diff ${{ github.event.pull_request.number }}
          3. Focus ONLY on files in packages/backend/convex/ or any path containing 'convex/'
          4. Analyze changed lines against the 15 violations from the reference document

          ANALYSIS PROCESS:
          - Show your step-by-step analysis for each file
          - Explain WHY each violation exists and WHY it matters (reference the best practices doc)
          - Include line-by-line reasoning for violations found
          - Mention checks that passed (no violation found)
          - For missing await detection: Look at 2-3 lines before ctx.* calls to find 'await' or 'const x = await'
          - Be extra careful with multi-line statements - 'await' may be on a previous line
          - Use the examples from convex_practices.md to guide your analysis

          Output format:
          
          ANALYSIS_START
          [Explain your analysis process, what you checked, reasoning for each violation]
          ANALYSIS_END

          For each violation found, output EXACTLY this format:
          VIOLATION|[rule_number]|[file_path]|[line_number]|[category]|[description]|[fix_suggestion]

          Example:
          ANALYSIS_START
          Checking schema.ts lines 110-120: Found by_user index on line 115. Also found by_user_status composite index on line 117. Since composite indexes can handle queries on prefix fields, the by_user index is redundant and wastes storage.

          Checking sessions.ts lines 300-305: Found 'const sessionId = await ctx.runMutation(...)' on line 303. The 'await' keyword is present before ctx.runMutation, so this is correctly awaited. NO VIOLATION.
          ANALYSIS_END
          VIOLATION|8|packages/backend/convex/schema.ts|115|Performance|Redundant index - by_user covered by by_user_status|Remove the by_user index

          If no violations found, output: 
          ANALYSIS_START
          [Explain what you checked and why no violations were found]
          ANALYSIS_END
          NO_VIOLATIONS_FOUND

          IMPORTANT: Only analyze changed lines, provide specific line numbers, include detailed reasoning." > analysis_output.txt

      - name: Show analysis results
        run: |
          echo "=== CURSOR-AGENT ANALYSIS OUTPUT ==="
          cat analysis_output.txt
          echo "=== END ANALYSIS OUTPUT ==="

      - name: Create GitHub review from analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if grep -q "NO_VIOLATIONS_FOUND" analysis_output.txt; then
            echo "No violations found, skipping review creation"
            exit 0
          fi

          # Count violations and create summary
          violation_count=$(grep -c "VIOLATION|" analysis_output.txt || echo "0")
          
          if [ "$violation_count" -eq 0 ]; then
            echo "No violations found, skipping review creation"
            exit 0
          fi

          # Create summary based on violation count
          if [ "$violation_count" -eq 1 ]; then
            summary="Found 1 Convex best practice improvement."
          else
            summary="Found $violation_count Convex best practice improvements."
          fi

          # Start building the review JSON
          cat > review.json << EOF
          {
            "event": "COMMENT",
            "body": "$summary",
            "comments": [
          EOF

          # Process each violation and add to comments array
          first=true
          while IFS='|' read -r prefix rule_num file_path line_num category description fix; do
            if [ "$prefix" = "VIOLATION" ]; then
              # Check if this violation already exists
              comment_id="convex-rule-${rule_num}-$(basename "$file_path")-${line_num}"
              if grep -q "$comment_id" existing_comments.txt; then
                echo "Skipping duplicate comment: $comment_id"
                continue
              fi

              # Determine emoji based on category
              case "$category" in
                "Critical") emoji="ðŸš¨" ;;
                "Performance") emoji="âš¡" ;;
                "Quality") emoji="âš ï¸" ;;
                *) emoji="â„¹ï¸" ;;
              esac

              # Add comma if not first comment
              if [ "$first" = false ]; then
                echo "," >> review.json
              fi
              first=false

              # Add the comment to JSON
              cat >> review.json << EOF
              {
                "path": "$file_path",
                "line": $line_num,
                "side": "RIGHT",
                "body": "$emoji $category: $description\n\n<!-- $comment_id -->\n\n**Fix:** $fix"
              }
          EOF
            fi
          done < analysis_output.txt

          # Close the JSON
          cat >> review.json << EOF
            ]
          }
          EOF

          # Only submit if we have comments
          if [ "$first" = true ]; then
            echo "No new violations to report (all already exist)"
            exit 0
          fi

          # Submit the review
          echo "Submitting review with $(jq '.comments | length' review.json) comments"
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            -X POST --input review.json