name: Convex Best Practices Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'packages/backend/convex/**'
      - '**/convex/**'

concurrency:
  group: convex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  convex-best-practices:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Configure git identity
        run: |
          git config user.name "Convex Best Practices Bot"
          git config user.email "convex-bot@syntaxia.com"

      - name: Convex Best Practices Review
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          MODEL: auto
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cursor-agent --force --model "$MODEL" --output-format=text --print 'You are a specialized Convex code reviewer operating in GitHub Actions. Focus ONLY on Convex best practices violations.

          Context:
          - Repo: ${{ github.repository }}
          - PR Number: ${{ github.event.pull_request.number }}
          - PR Head SHA: ${{ github.event.pull_request.head.sha }}
          - PR Base SHA: ${{ github.event.pull_request.base.sha }}

          Convex Best Practices to Check:

          üö® CRITICAL ISSUES (Informational):
          1. Missing await on promises (ctx.db.*, ctx.runQuery, ctx.runMutation, ctx.scheduler.*)
          2. Using .filter() on database queries instead of .withIndex()
          3. Using .collect() on potentially large result sets without pagination
          4. Missing argument validators on public functions
          5. Missing access control on public functions
          6. Scheduling public functions instead of internal functions
          7. Direct database access (ctx.db) in actions

          ‚ö° PERFORMANCE ISSUES (Informational):
          8. Redundant indexes in schema.ts
          9. Unnecessary ctx.runAction() calls (use helper functions instead)
          10. Sequential ctx.runQuery/ctx.runMutation calls in actions
          11. Overuse of ctx.runQuery/ctx.runMutation in queries/mutations

          ‚ö†Ô∏è CODE QUALITY ISSUES (Informational):
          12. Missing returns validator (should use v.null() if no return)
          13. Using deprecated v.bigint() instead of v.int64()
          14. Missing "use node"; directive in actions using Node.js
          15. Incorrect TypeScript types for Convex IDs (use Id<"table"> not string)

          Procedure:
          - Get existing comments: gh pr view --json comments
          - Get diff of only Convex files: gh pr diff -- "**/convex/**"
          - Analyze ONLY changed lines in Convex files
          - Focus on the 15 specific violations listed above

          Analysis Rules:
          - ONLY flag clear violations of the 15 specific practices above
          - Provide specific line references and suggest fixes
          - Include code examples in comments when helpful

          Commenting Format:
          - üö® Critical: [Brief description] - [Specific fix]
          - ‚ö° Performance: [Brief description] - [Optimization suggestion]  
          - ‚ö†Ô∏è Quality: [Brief description] - [Improvement suggestion]

          Submission Rules:
          - Max 15 inline comments total
          - Place comments on exact changed lines only
          - Submit via GitHub Reviews API with inline comments
          - Provide informational feedback only - DO NOT block PRs
          - All comments are suggestions for improvement
          
          Summary Format:
          - Keep it under 3 sentences
          - Use natural language, not AI-speak
          - Examples:
            * "Found 2 performance improvements in schema indexes and 1 missing await."
            * "Code looks good - just a couple minor optimizations possible."
            * "Spotted 3 small issues: redundant index, sequential queries, missing validator."
          - Avoid phrases like "I have analyzed" or "In conclusion"
          '